import{r as l,Z as h,j as e,ak as v,T as O,aC as ee,k as te,S as ae,n as se,D as L,X as re}from"./index-JhQGfP3r.js";import{e as ne}from"./exportToCsv-CTUkvpR5.js";import{D as ie}from"./DataTable-ZpmiLouZ.js";import{M as le}from"./Modal-Ul9aPZYl.js";import{S as k}from"./StatCard-By2eovuR.js";import{u as oe,t as de,o as ce,s as _,e as me}from"./types-DpNt5E6n.js";import{V as D}from"./index-BJu9RWF7.js";import{E as ue}from"./eye-Bcuk08KK.js";const he=ce({payment_method:me(["cash","bank_transfer","check"],{message:"Ödeme yöntemi seçiniz"}),bank_account:_().optional(),transaction_ref:_().optional(),notes:_().optional()});function ke(){var E,Y,F;const[S,q]=l.useState([]),[b,A]=l.useState({totalApproved:0,totalDistributed:0,pendingDistribution:0,monthlyTotal:0}),[I,H]=l.useState(!0),[p,V]=l.useState(""),[y,$]=l.useState("all"),[g,z]=l.useState("all"),[K,x]=l.useState(!1),[n,T]=l.useState(null),{register:f,handleSubmit:P,formState:{errors:C},reset:Q,watch:U}=oe({resolver:de(he)}),N=U("payment_method");l.useEffect(()=>{M(),R()},[]);const M=async()=>{try{const{data:t,error:a}=await h.from("aid_records").select(`
          *,
          beneficiaries (
            name,
            surname,
            phone,
            category
          ),
          payments (
            id,
            payment_method,
            amount,
            status,
            paid_at
          )
        `).eq("aid_type","cash").order("created_at",{ascending:!1});if(a)throw a;q(t||[])}catch(t){console.error("Nakdi yardım kayıtları yüklenirken hata:",t),D.error("Nakdi yardım kayıtları yüklenirken hata oluştu")}finally{H(!1)}},R=async()=>{try{const{data:t}=await h.from("aid_records").select("amount").eq("aid_type","cash").eq("status","approved"),a=(t==null?void 0:t.reduce((i,d)=>i+(d.amount||0),0))||0,{data:s}=await h.from("aid_records").select("amount").eq("aid_type","cash").in("status",["distributed","completed"]),r=(s==null?void 0:s.reduce((i,d)=>i+(d.amount||0),0))||0,o=a-r,j=new Date().toISOString().slice(0,7),{data:m}=await h.from("aid_records").select("amount").eq("aid_type","cash").gte("created_at",`${j}-01`),u=(m==null?void 0:m.reduce((i,d)=>i+(d.amount||0),0))||0;A({totalApproved:a,totalDistributed:r,pendingDistribution:o,monthlyTotal:u})}catch(t){console.error("İstatistikler yüklenirken hata:",t)}},w=l.useMemo(()=>S.filter(t=>{var o,j,m;const a=p===""||`${(o=t.beneficiaries)==null?void 0:o.name} ${(j=t.beneficiaries)==null?void 0:j.surname}`.toLowerCase().includes(p.toLowerCase())||((m=t.notes)==null?void 0:m.toLowerCase().includes(p.toLowerCase())),s=y==="all"||t.status===y;let r=!0;if(g!=="all"){const u=new Date(t.created_at),i=new Date;switch(g){case"today":{r=u.toDateString()===i.toDateString();break}case"week":{const d=new Date(i.getTime()-6048e5);r=u>=d;break}case"month":{r=u.getMonth()===i.getMonth()&&u.getFullYear()===i.getFullYear();break}}}return a&&s&&r}),[S,p,y,g]),W=async t=>{if(n)try{const{error:a}=await h.from("payments").insert({aid_record_id:n.id,payment_method:t.payment_method,amount:n.amount,bank_account:t.bank_account,transaction_ref:t.transaction_ref,status:"completed",paid_at:new Date().toISOString(),notes:t.notes});if(a)throw a;const{error:s}=await h.from("aid_records").update({status:"distributed",distributed_at:new Date().toISOString()}).eq("id",n.id);if(s)throw s;D.success("Nakdi yardım başarıyla dağıtıldı"),x(!1),T(null),Q(),M(),R()}catch(a){console.error("Nakdi yardım dağıtılırken hata:",a),D.error("Nakdi yardım dağıtılırken hata oluştu")}},X=t=>{const s={approved:{label:"Onaylandı",class:"bg-green-100 text-green-800",icon:v},distributed:{label:"Dağıtıldı",class:"bg-blue-100 text-blue-800",icon:O},completed:{label:"Tamamlandı",class:"bg-purple-100 text-purple-800",icon:v},cancelled:{label:"İptal Edildi",class:"bg-red-100 text-red-800",icon:re}}[t]||{label:t,class:"bg-gray-100 text-gray-800",icon:v},r=s.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${s.class}`,children:[e.jsx(r,{className:"h-3 w-3"}),s.label]})},Z=t=>({cash:"Nakit",bank_transfer:"Banka Havalesi",check:"Çek"})[t]||t,c=t=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(t),B=t=>new Date(t).toLocaleDateString("tr-TR"),G=t=>new Date(t).toLocaleString("tr-TR"),J=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(t,a)=>{var s,r,o;return e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[(s=a.beneficiaries)==null?void 0:s.name," ",(r=a.beneficiaries)==null?void 0:r.surname]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(o=a.beneficiaries)==null?void 0:o.category})]})}},{key:"amount",header:"Tutar",render:(t,a)=>e.jsx("div",{className:"font-medium text-green-600",children:c(a.amount)})},{key:"status",header:"Durum",render:(t,a)=>X(a.status)},{key:"approved_at",header:"Onay Tarihi",render:(t,a)=>B(a.approved_at)},{key:"distributed_at",header:"Dağıtım Tarihi",render:(t,a)=>a.distributed_at?B(a.distributed_at):"-"},{key:"payments",header:"Ödeme Yöntemi",render:(t,a)=>{var r;const s=(r=a.payments)==null?void 0:r[0];return s?Z(s.payment_method):"-"}},{key:"notes",header:"Notlar",render:(t,a)=>e.jsx("div",{className:"max-w-xs truncate",title:a.notes,children:a.notes||"-"})},{key:"actions",header:"İşlemler",render:(t,a)=>e.jsxs("div",{className:"flex items-center gap-2",children:[a.status==="approved"&&e.jsx("button",{onClick:()=>{T(a),x(!0)},className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Dağıt",children:e.jsx(L,{className:"h-4 w-4"})}),e.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:e.jsx(ue,{className:"h-4 w-4"})})]})}];return I?e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Nakdi Yardım Veznesi"}),e.jsx("p",{className:"text-muted-foreground",children:"Nakdi yardımları yönetin ve dağıtın"})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[e.jsx(k,{title:"Toplam Onaylanan",value:c(b.totalApproved),icon:v,accentClass:"bg-green-100"}),e.jsx(k,{title:"Toplam Dağıtılan",value:c(b.totalDistributed),icon:O,accentClass:"bg-blue-100"}),e.jsx(k,{title:"Dağıtım Bekleyen",value:c(b.pendingDistribution),icon:ee,accentClass:"bg-orange-100"}),e.jsx(k,{title:"Bu Ay Toplam",value:c(b.monthlyTotal),icon:te,accentClass:"bg-purple-100"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Kayıt ara...",value:p,onChange:t=>V(t.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),e.jsxs("select",{value:y,onChange:t=>$(t.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Durumlar"}),e.jsx("option",{value:"approved",children:"Onaylanan"}),e.jsx("option",{value:"distributed",children:"Dağıtılan"}),e.jsx("option",{value:"completed",children:"Tamamlanan"}),e.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),e.jsxs("select",{value:g,onChange:t=>z(t.target.value),className:"rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"Tüm Tarihler"}),e.jsx("option",{value:"today",children:"Bugün"}),e.jsx("option",{value:"week",children:"Bu Hafta"}),e.jsx("option",{value:"month",children:"Bu Ay"})]}),e.jsxs("button",{onClick:()=>ne("nakdi-yardim-kayitlari.csv",w),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(se,{className:"h-4 w-4"}),"İndir"]}),e.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[w.length," kayıt"]})]}),e.jsx(ie,{columns:J,data:w}),e.jsxs(le,{open:K,onClose:()=>x(!1),children:[e.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Nakdi Yardım Dağıtımı"}),e.jsx("button",{onClick:()=>x(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),n&&e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"rounded border p-4 bg-gray-50",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Yardım Detayları"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"İhtiyaç Sahibi:"})," ",(E=n.beneficiaries)==null?void 0:E.name," ",(Y=n.beneficiaries)==null?void 0:Y.surname]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Kategori:"})," ",(F=n.beneficiaries)==null?void 0:F.category]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Tutar:"})," ",c(n.amount)]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Onay Tarihi:"})," ",G(n.approved_at)]}),n.notes&&e.jsxs("div",{children:[e.jsx("strong",{children:"Notlar:"})," ",n.notes]})]})]}),e.jsxs("form",{onSubmit:P(W),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Ödeme Yöntemi *"}),e.jsxs("select",{...f("payment_method"),className:"w-full rounded border px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"Seçiniz..."}),e.jsx("option",{value:"cash",children:"Nakit"}),e.jsx("option",{value:"bank_transfer",children:"Banka Havalesi"}),e.jsx("option",{value:"check",children:"Çek"})]}),C.payment_method&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:C.payment_method.message})]}),N==="bank_transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Hesap No"}),e.jsx("input",{type:"text",...f("bank_account"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00"})]}),(N==="bank_transfer"||N==="check")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"İşlem Referansı"}),e.jsx("input",{type:"text",...f("transaction_ref"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"İşlem numarası veya referans kodu"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),e.jsx("textarea",{...f("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Dağıtım ile ilgili notlar..."})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>x(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),e.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-sm text-white hover:bg-green-700",children:[e.jsx(L,{className:"h-4 w-4"}),"Dağıt"]})]})]})]})]})]})}export{ke as default};
