import{v as U,aw as f,r as l,j as e,c as z,e as me,S as ee,b8 as re,O as xe,t as ne,b9 as he,ba as te,b6 as B,b7 as X,i as Z,ak as pe,X as ie,n as ge,E as se,bb as fe,o as oe,b as ye,P as we,J as _e,Z as W}from"./index-JhQGfP3r.js";import{A as je}from"./archive-CcIzEuUG.js";import{R as ve}from"./reply-BDGCySaV.js";import{P as be}from"./pen-4BfTGSl7.js";import{I as Ne}from"./image-CQcKvywD.js";import{A as ke}from"./arrow-left-BUmeGPne.js";import{V as Se}from"./video-BO520JC0.js";const ae=U("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),De=U("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]),Me=U("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),p=(t,s)=>{console.error(`${s}:`,t);const r=(t==null?void 0:t.message)||`Error in ${s}`;throw f.error(r),new Error(r)},q=()=>[{id:"conv_1",name:"Yönetim Kurulu",conversation_type:"group",created_by:"user1",description:"Yönetim kurulu iç iletişimi",is_archived:!1,last_message_at:new Date(Date.now()-30*60*1e3).toISOString(),created_at:new Date(Date.now()-30*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()},{id:"conv_2",name:"Proje Koordinasyonu",conversation_type:"group",created_by:"user2",description:"Aktif projeler için koordinasyon",is_archived:!1,last_message_at:new Date(Date.now()-2*60*60*1e3).toISOString(),created_at:new Date(Date.now()-15*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()},{id:"conv_3",conversation_type:"direct",created_by:"user1",is_archived:!1,last_message_at:new Date(Date.now()-5*60*1e3).toISOString(),created_at:new Date(Date.now()-7*24*60*60*1e3).toISOString(),updated_at:new Date().toISOString()}],J=t=>[{id:"msg_1",sender_id:"user1",conversation_id:t,content:"Merhaba, toplantı için gündem maddelerini gözden geçirelim.",message_type:"text",created_at:new Date(Date.now()-60*60*1e3).toISOString(),updated_at:new Date(Date.now()-60*60*1e3).toISOString()},{id:"msg_2",sender_id:"user2",conversation_id:t,content:"Evet, bütçe konularını da ekleyelim. Dosyayı paylaşıyorum.",message_type:"text",created_at:new Date(Date.now()-45*60*1e3).toISOString(),updated_at:new Date(Date.now()-45*60*1e3).toISOString()},{id:"msg_3",sender_id:"user2",conversation_id:t,content:"budget_2024.pdf",message_type:"file",file_url:"https://example.com/budget_2024.pdf",file_name:"budget_2024.pdf",file_size:245760,created_at:new Date(Date.now()-30*60*1e3).toISOString(),updated_at:new Date(Date.now()-30*60*1e3).toISOString()},{id:"msg_4",sender_id:"user3",conversation_id:t,content:"Harika! Ben de proje raporlarını hazırladım. Yarın sunabilirim.",message_type:"text",reply_to:"msg_2",created_at:new Date(Date.now()-15*60*1e3).toISOString(),updated_at:new Date(Date.now()-15*60*1e3).toISOString()},{id:"msg_5",sender_id:"user1",conversation_id:t,content:"Mükemmel! O zaman yarın saat 14:00'da başlayalım.",message_type:"text",created_at:new Date(Date.now()-5*60*1e3).toISOString(),updated_at:new Date(Date.now()-5*60*1e3).toISOString()}],Ce=t=>[{id:"part_1",conversation_id:t,user_id:"user1",role:"admin",joined_at:new Date(Date.now()-30*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-10*60*1e3).toISOString()},{id:"part_2",conversation_id:t,user_id:"user2",role:"member",joined_at:new Date(Date.now()-25*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-20*60*1e3).toISOString()},{id:"part_3",conversation_id:t,user_id:"user3",role:"member",joined_at:new Date(Date.now()-20*24*60*60*1e3).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-5*60*1e3).toISOString()}],E={async getConversations(){try{return q()}catch(t){return p(t,"getConversations"),[]}},async getConversation(t){try{return q().find(r=>r.id===t)||null}catch(s){return p(s,"getConversation"),null}},async createConversation(t){try{const s={id:`conv_${Date.now()}`,name:t.name,conversation_type:t.conversation_type,created_by:"current_user",description:t.description,is_archived:!1,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return t.participants.length>0&&await this.addParticipants(s.id,t.participants),f.success("Konuşma oluşturuldu"),s}catch(s){throw p(s,"createConversation"),s}},async updateConversation(t,s){try{const i=q().find(m=>m.id===t);if(!i)throw new Error("Konuşma bulunamadı");const u={...i,...s,updated_at:new Date().toISOString()};return f.success("Konuşma güncellendi"),u}catch(r){throw p(r,"updateConversation"),r}},async deleteConversation(t){try{f.success("Konuşma silindi")}catch(s){throw p(s,"deleteConversation"),s}},async archiveConversation(t){try{f.success("Konuşma arşivlendi")}catch(s){throw p(s,"archiveConversation"),s}},async getMessages(t){try{return J(t)}catch(s){return p(s,"getMessages"),[]}},async sendMessage(t){try{const s={id:`msg_${Date.now()}`,sender_id:"current_user",conversation_id:t.conversation_id,content:t.content,message_type:t.message_type||"text",file_url:t.file_url,file_name:t.file_name,file_size:t.file_size,reply_to:t.reply_to,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};return await this.updateConversationLastMessage(t.conversation_id),s}catch(s){throw p(s,"sendMessage"),s}},async editMessage(t,s){try{const i=J("conv_1").find(m=>m.id===t);if(!i)throw new Error("Mesaj bulunamadı");const u={...i,content:s,edited_at:new Date().toISOString(),updated_at:new Date().toISOString()};return f.success("Mesaj düzenlendi"),u}catch(r){throw p(r,"editMessage"),r}},async deleteMessage(t){try{f.success("Mesaj silindi")}catch(s){throw p(s,"deleteMessage"),s}},async markMessageAsRead(t){},async getConversationParticipants(t){try{return Ce(t)}catch(s){return p(s,"getConversationParticipants"),[]}},async addParticipants(t,s){try{const r=s.map(i=>({id:`part_${Date.now()}_${i}`,conversation_id:t,user_id:i,role:"member",joined_at:new Date().toISOString(),is_muted:!1}));return f.success(`${s.length} katılımcı eklendi`),r}catch(r){throw p(r,"addParticipants"),r}},async removeParticipant(t,s){try{f.success("Katılımcı çıkarıldı")}catch(r){throw p(r,"removeParticipant"),r}},async updateParticipantRole(t,s,r){try{f.success("Katılımcı rolü güncellendi")}catch(i){throw p(i,"updateParticipantRole"),i}},async muteConversation(t,s,r){try{f.success(r?"Konuşma sessize alındı":"Konuşma sessize alma kaldırıldı")}catch(i){throw p(i,"muteConversation"),i}},async markConversationAsRead(t){},async addReaction(t,s){try{return{id:`reaction_${Date.now()}`,message_id:t,user_id:"current_user",emoji:s,created_at:new Date().toISOString()}}catch(r){throw p(r,"addReaction"),r}},async removeReaction(t){},async getMessageReactions(t){try{return[{id:"reaction_1",message_id:t,user_id:"user1",emoji:"👍",created_at:new Date().toISOString()},{id:"reaction_2",message_id:t,user_id:"user2",emoji:"❤️",created_at:new Date().toISOString()}]}catch(s){return p(s,"getMessageReactions"),[]}},async searchMessages(t,s){try{return J(s||"conv_1").filter(i=>i.content.toLowerCase().includes(t.toLowerCase()))}catch(r){return p(r,"searchMessages"),[]}},async getNotifications(t){try{return[{id:"notif_1",user_id:t,conversation_id:"conv_1",message_id:"msg_1",type:"new_message",is_read:!1,created_at:new Date(Date.now()-18e5).toISOString()},{id:"notif_2",user_id:t,conversation_id:"conv_2",message_id:"msg_2",type:"mention",is_read:!1,created_at:new Date(Date.now()-36e5).toISOString()}]}catch(s){return p(s,"getNotifications"),[]}},async markNotificationAsRead(t){},subscribeToConversation(t,s){return console.log(`Subscribed to conversation ${t}`),{unsubscribe:()=>console.log(`Unsubscribed from conversation ${t}`)}},subscribeToNotifications(t,s){return console.log(`Subscribed to notifications for user ${t}`),{unsubscribe:()=>console.log(`Unsubscribed from notifications for user ${t}`)}},async updateConversationLastMessage(t){},async getUnreadCount(t,s){try{return Math.floor(Math.random()*5)}catch(r){return console.error("Failed to get unread count:",r),0}}};function Oe({conversations:t,selectedConversationId:s,onSelectConversation:r,onCreateConversation:i,onSearchConversations:u,onUpdateConversations:m,loading:N=!1,currentUserId:j}){const[g,M]=l.useState(""),[k,x]=l.useState(null),[h,v]=l.useState({}),[R,C]=l.useState(new Set),[y,P]=l.useState("all");l.useEffect(()=>{(async()=>{if(!j)return;const c={};for(const O of t)try{const D=await E.getUnreadCount(O.id,j);c[O.id]=D}catch(D){console.error("Failed to load unread count:",D)}v(c)})()},[t,j]),l.useEffect(()=>{C(new Set(["user1","user2","user3"]))},[]),l.useEffect(()=>{const a=()=>x(null);return document.addEventListener("click",a),()=>document.removeEventListener("click",a)},[]);const w=a=>{M(a),u==null||u(a)},S=t.filter(a=>{var D,V;const c=!g||((D=a.name)==null?void 0:D.toLowerCase().includes(g.toLowerCase()))||((V=a.description)==null?void 0:V.toLowerCase().includes(g.toLowerCase())),O=y==="all"||y==="unread"&&(h[a.id]||0)>0||y==="groups"&&a.conversation_type==="group"||y==="direct"&&a.conversation_type==="direct";return c&&O&&!a.is_archived}),K=a=>{if(!a)return"";const c=new Date(a),D=(new Date().getTime()-c.getTime())/(1e3*60*60);return D<1?"şimdi":D<24?B(c,"HH:mm"):D<168?B(c,"EEE",{locale:X}):B(c,"dd/MM",{locale:X})},F=a=>a.conversation_type==="group"?a.name||"İsimsiz Grup":"Direkt Mesaj",T=a=>a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:F(a),className:"w-12 h-12 rounded-full object-cover"}):e.jsxs("div",{className:"w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white relative",children:[a.conversation_type==="group"?e.jsx(Z,{className:"h-6 w-6"}):e.jsx(te,{className:"h-6 w-6"}),a.conversation_type==="direct"&&R.has("user1")&&e.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 border-2 border-white rounded-full"})]}),o=(a,c)=>{a.stopPropagation(),x(k===c?null:c)},b=async a=>{try{await E.archiveConversation(a),m==null||m(),x(null)}catch(c){console.error("Failed to archive conversation:",c)}},A=async(a,c)=>{if(j)try{await E.muteConversation(a,j,c),x(null)}catch(O){console.error("Failed to mute conversation:",O)}},Y=async a=>{if(window.confirm("Bu konuşmayı silmek istediğinizden emin misiniz?"))try{await E.deleteConversation(a),m==null||m(),x(null)}catch(c){console.error("Failed to delete conversation:",c)}},G=()=>{x(null)},Q=a=>h[a]||0;return e.jsxs("div",{className:"w-80 border-r bg-card flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Mesajlar"}),i&&e.jsxs(z,{size:"sm",onClick:i,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Yeni"]})]}),e.jsxs("div",{className:"relative mb-3",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx("input",{type:"text",placeholder:"Konuşma ara...",value:g,onChange:a=>w(a.target.value),className:"w-full pl-10 pr-3 py-2 border border-input rounded-md bg-background text-sm"})]}),e.jsx("div",{className:"flex space-x-1 p-1 bg-muted rounded-lg",children:[{id:"all",label:"Tümü",count:t.length},{id:"unread",label:"Okunmayan",count:Object.values(h).reduce((a,c)=>a+(c>0?1:0),0)},{id:"groups",label:"Gruplar",count:t.filter(a=>a.conversation_type==="group").length},{id:"direct",label:"Direkt",count:t.filter(a=>a.conversation_type==="direct").length}].map(a=>e.jsxs("button",{onClick:()=>P(a.id),className:`flex-1 text-xs py-1.5 px-2 rounded transition-colors ${y===a.id?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"}`,children:[a.label,a.count>0&&e.jsxs("span",{className:"ml-1 text-xs",children:["(",a.count,")"]})]},a.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:N?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Yükleniyor..."})]}):S.length>0?e.jsx("div",{className:"space-y-1 p-2",children:S.map(a=>{const c=Q(a.id);return e.jsxs("div",{className:`relative group cursor-pointer rounded-lg p-3 transition-colors ${s===a.id?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"}`,onClick:()=>r(a),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[T(a),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:`truncate ${c>0?"font-semibold":"font-medium"}`,children:F(a)}),a.conversation_type==="group"&&e.jsx(Me,{className:"h-3 w-3 text-muted-foreground"}),e.jsx(ae,{className:"h-3 w-3 text-muted-foreground opacity-0"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[c>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full min-w-[18px] text-center font-medium",children:c>99?"99+":c}),a.last_message_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:K(a.last_message_at)}),e.jsx("button",{onClick:O=>o(O,a.id),className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-background/50 rounded transition-opacity",children:e.jsx(re,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex items-center justify-between mt-1",children:e.jsx("p",{className:`text-sm truncate ${c>0?"text-foreground":"text-muted-foreground"}`,children:a.description||"Henüz mesaj yok"})})]})]}),k===a.id&&e.jsxs("div",{className:"absolute top-12 right-3 bg-background border rounded-lg shadow-lg z-20 min-w-[160px]",children:[e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",onClick:()=>A(a.id,!0),children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Sessize Al"]}),a.conversation_type==="group"&&e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Grup Ayarları"]}),e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",onClick:()=>b(a.id),children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Arşivle"]}),e.jsx("div",{className:"border-t border-muted my-1"}),e.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-destructive",onClick:()=>Y(a.id),children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),a.conversation_type==="group"?"Gruptan Ayrıl":"Konuşmayı Sil"]})]})]},a.id)})}):e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:g?e.jsxs("div",{children:[e.jsx(ee,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Arama kriterlerine uygun konuşma bulunamadı"}),e.jsxs("p",{className:"text-xs mt-1",children:["'",g,"' için sonuç yok"]})]}):y==="unread"?e.jsxs("div",{children:[e.jsx(he,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Okunmamış mesaj yok"})]}):e.jsxs("div",{children:[e.jsx(te,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Henüz konuşma başlatılmamış"}),i&&e.jsx(z,{size:"sm",className:"mt-3",onClick:i,children:"İlk konuşmayı başlat"})]})})}),k&&e.jsx("div",{className:"fixed inset-0 z-10",onClick:G})]})}function ze({message:t,isCurrentUser:s,onReply:r,onEdit:i,onDelete:u,showSender:m=!0,onFileDownload:N,isEditing:j=!1,onSaveEdit:g,onCancelEdit:M}){const[k,x]=l.useState(!1),[h,v]=l.useState(t.content||""),R=w=>{const S=new Date(w),K=new Date;return S.toDateString()===K.toDateString()?B(S,"HH:mm"):B(S,"dd MMM HH:mm",{locale:X})},C=()=>{h.trim()&&g&&g(t.id,h.trim())},y=()=>{v(t.content||""),M==null||M()},P=()=>{if(j&&t.message_type==="text")return e.jsxs("div",{className:"space-y-2",children:[e.jsx("textarea",{value:h,onChange:w=>v(w.target.value),className:"w-full p-2 border rounded resize-none focus:ring-2 focus:ring-primary focus:border-transparent",rows:3,autoFocus:!0,onKeyDown:w=>{w.key==="Enter"&&!w.shiftKey?(w.preventDefault(),C()):w.key==="Escape"&&y()}}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:C,disabled:!h.trim(),className:"flex items-center gap-1 px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(pe,{className:"h-3 w-3"}),"Kaydet"]}),e.jsxs("button",{onClick:y,className:"flex items-center gap-1 px-2 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600",children:[e.jsx(ie,{className:"h-3 w-3"}),"İptal"]})]})]});switch(t.message_type){case"file":return e.jsxs("div",{className:"flex items-center space-x-3 p-3 border rounded-lg bg-muted/50",children:[e.jsx(De,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:t.file_name}),t.file_size&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(t.file_size/1024/1024).toFixed(2)," MB"]})]}),t.file_url&&e.jsx("button",{onClick:()=>N==null?void 0:N(t.file_url,t.file_name),className:"p-2 hover:bg-muted rounded-md",children:e.jsx(ge,{className:"h-4 w-4"})})]});case"image":return e.jsxs("div",{className:"space-y-2",children:[t.file_url&&e.jsx("img",{src:t.file_url,alt:t.file_name||"Resim",className:"max-w-xs rounded-lg cursor-pointer hover:opacity-90",onClick:()=>window.open(t.file_url,"_blank")}),t.content&&e.jsx("div",{className:"text-sm",children:t.content})]});case"system":return e.jsx("div",{className:"text-sm text-muted-foreground italic",children:t.content});default:return e.jsx("div",{className:"whitespace-pre-wrap break-words",children:t.content})}};return e.jsxs("div",{className:`flex gap-3 group ${s?"flex-row-reverse":""}`,children:[m&&!s&&e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-sm flex-shrink-0",children:t.sender_id.charAt(0).toUpperCase()}),e.jsxs("div",{className:`flex-1 max-w-xs sm:max-w-md ${s?"flex flex-col items-end":""}`,children:[m&&!s&&e.jsxs("div",{className:"text-sm text-muted-foreground mb-1",children:["Kullanıcı ",t.sender_id]}),t.reply_to&&e.jsxs("div",{className:"mb-2 p-2 bg-muted/50 border-l-2 border-primary rounded text-sm",children:[e.jsx("div",{className:"text-muted-foreground",children:"Yanıtlanan mesaj"}),e.jsx("div",{className:"truncate",children:"..."})]}),e.jsxs("div",{className:`relative rounded-lg p-3 ${t.message_type==="system"?"bg-muted/30 text-center":s?"bg-primary text-primary-foreground":"bg-card border"}`,children:[P(),e.jsxs("div",{className:`text-xs mt-2 ${t.message_type==="system"?"text-muted-foreground":s?"text-primary-foreground/70":"text-muted-foreground"}`,children:[R(t.created_at),t.edited_at&&e.jsx("span",{className:"ml-1",children:"(düzenlendi)"})]}),t.message_type!=="system"&&!j&&e.jsx("div",{className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>x(!k),className:"p-1 hover:bg-background/20 rounded",children:e.jsx(re,{className:"h-3 w-3"})}),k&&e.jsxs("div",{className:"absolute top-full right-0 mt-1 bg-background border rounded-lg shadow-lg z-10 min-w-[120px]",children:[r&&e.jsxs("button",{onClick:()=>{r(t),x(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",children:[e.jsx(ve,{className:"h-3 w-3 mr-2"}),"Yanıtla"]}),s&&i&&t.message_type==="text"&&e.jsxs("button",{onClick:()=>{i(t),x(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[e.jsx(be,{className:"h-3 w-3 mr-2"}),"Düzenle"]}),s&&u&&e.jsxs("button",{onClick:()=>{u(t.id),x(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-red-600",children:[e.jsx(ne,{className:"h-3 w-3 mr-2"}),"Sil"]})]})]})})]})]}),k&&e.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>x(!1)})]})}function Ie({onSendMessage:t,onFileUpload:s,replyingTo:r,onCancelReply:i,disabled:u=!1,placeholder:m="Mesajınızı yazın..."}){const[N,j]=l.useState(""),[g,M]=l.useState(!1),[k,x]=l.useState(!1),h=l.useRef(null),v=l.useRef(null),R=async()=>{N.trim()&&!u&&(t(N.trim()),j(""),v.current&&(v.current.style.height="auto"))},C=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),R())},y=async o=>{if(s){M(!0);try{const b=await s(o),A=o.type.startsWith("image/")?"image":"file";t(o.type.startsWith("image/")?"":`📎 ${b.name}`,A)}catch(b){console.error("File upload failed:",b)}finally{M(!1)}}},P=o=>{var A;const b=(A=o.target.files)==null?void 0:A[0];b&&y(b)},w=o=>{o.preventDefault(),x(!1);const b=o.dataTransfer.files[0];b&&y(b)},S=o=>{o.preventDefault(),x(!0)},K=o=>{o.preventDefault(),x(!1)},F=o=>{o.style.height="auto",o.style.height=Math.min(o.scrollHeight,120)+"px"},T=o=>{j(o.target.value),F(o.target)};return e.jsxs("div",{className:"border-t bg-background p-4",children:[r&&e.jsxs("div",{className:"mb-3 p-3 bg-muted/50 border-l-2 border-primary rounded flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Kullanıcı ",r.sender_id," kullanıcısına yanıt veriyor"]}),e.jsx("div",{className:"text-sm truncate mt-1",children:r.content||(r.message_type==="file"?`📎 ${r.file_name}`:"Dosya")})]}),i&&e.jsx(z,{size:"sm",variant:"ghost",onClick:i,children:e.jsx(ie,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:`relative ${k?"bg-primary/10 border-primary":""}`,onDrop:w,onDragOver:S,onDragLeave:K,children:[k&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-primary/5 border-2 border-dashed border-primary rounded-lg z-10",children:e.jsxs("div",{className:"text-center",children:[e.jsx(se,{className:"h-8 w-8 mx-auto text-primary mb-2"}),e.jsx("p",{className:"text-primary font-medium",children:"Dosyayı buraya bırakın"})]})}),e.jsxs("div",{className:"flex items-end space-x-2",children:[s&&e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("input",{ref:h,type:"file",onChange:P,className:"hidden",accept:"*/*"}),e.jsx(z,{type:"button",size:"sm",variant:"ghost",onClick:()=>{var o;return(o=h.current)==null?void 0:o.click()},disabled:u||g,className:"p-2",children:e.jsx(se,{className:"h-4 w-4"})}),e.jsx(z,{type:"button",size:"sm",variant:"ghost",onClick:()=>{h.current&&(h.current.accept="image/*",h.current.click())},disabled:u||g,className:"p-2",children:e.jsx(Ne,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("textarea",{ref:v,value:N,onChange:T,onKeyPress:C,placeholder:g?"Dosya yükleniyor...":m,disabled:u||g,className:"w-full min-h-[40px] max-h-[120px] px-3 py-2 border border-input rounded-md bg-background resize-none focus:ring-2 focus:ring-ring focus:border-transparent",rows:1}),e.jsx(z,{type:"button",size:"sm",variant:"ghost",className:"absolute right-2 top-1/2 transform -translate-y-1/2 p-1",disabled:u,children:e.jsx(fe,{className:"h-4 w-4"})})]}),e.jsx(z,{onClick:R,disabled:!N.trim()||u||g,size:"sm",className:"p-2",children:e.jsx(oe,{className:"h-4 w-4"})})]}),g&&e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"}),"Dosya yükleniyor..."]})]}),e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:"Enter ile gönder, Shift+Enter ile yeni satır"}),s&&e.jsx("span",{className:"ml-2",children:"• Dosya yüklemek için sürükleyip bırakabilirsiniz"})]})]})}function Fe(){const[t,s]=l.useState([]),[r,i]=l.useState(null),[u,m]=l.useState([]),[N,j]=l.useState([]),[g,M]=l.useState(!0),[k,x]=l.useState(!1),[h,v]=l.useState(null),[R,C]=l.useState(null),[y,P]=l.useState(!0),w=l.useRef(null),{user:S}=ye(),K=S==null?void 0:S.id;l.useEffect(()=>{T()},[!0]),l.useEffect(()=>{r&&(o(r.id),b(r.id),P(!1))},[r]),l.useEffect(()=>{A()},[u]);const T=async()=>{M(!0);try{const n=await E.getConversations();s(n)}catch(n){console.error("Failed to fetch conversations:",n),f.error("Konuşmalar yüklenirken hata oluştu")}finally{M(!1)}},o=async n=>{x(!0);try{const d=await E.getMessages(n);m(d),await E.markConversationAsRead(n)}catch(d){console.error("Failed to fetch messages:",d),f.error("Mesajlar yüklenirken hata oluştu")}finally{x(!1)}},b=async n=>{try{const d=await E.getConversationParticipants(n);j(d)}catch(d){console.error("Failed to fetch participants:",d)}},A=()=>{var n;(n=w.current)==null||n.scrollIntoView({behavior:"smooth"})},Y=async(n,d="text")=>{if(r)try{const _={conversation_id:r.id,content:n,message_type:d,reply_to:h==null?void 0:h.id},L=await E.sendMessage(_);m(I=>[...I,L]),v(null),s(I=>I.map($=>$.id===r.id?{...$,last_message_at:L.created_at}:$))}catch(_){console.error("Failed to send message:",_),f.error("Mesaj gönderilirken hata oluştu")}},G=async n=>{try{const _=["image/jpeg","image/png","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"];if(n.size>10485760)throw new Error("Dosya boyutu 10MB'den küçük olmalıdır");if(!_.includes(n.type))throw new Error("Desteklenmeyen dosya türü");const L=n.name.split(".").pop(),$=`internal-messages/${`${Date.now()}_${Math.random().toString(36).substring(2)}.${L}`}`,{error:H}=await W.storage.from("uploads").upload($,n);if(H)throw H;const{data:ue}=W.storage.from("uploads").getPublicUrl($);return{url:ue.publicUrl,name:n.name,size:n.size,path:$}}catch(d){throw console.error("File upload error:",d),d}},Q=async n=>{C(n.id)},a=async(n,d)=>{try{const{error:_}=await W.from("internal_messages").update({content:d,updated_at:new Date().toISOString()}).eq("id",n);if(_)throw _;m(L=>L.map(I=>I.id===n?{...I,content:d,updated_at:new Date().toISOString()}:I)),C(null)}catch(_){console.error("Error updating message:",_),f.error("Mesaj güncellenirken bir hata oluştu")}},c=()=>{C(null)},O=async n=>{if(window.confirm("Bu mesajı silmek istediğinizden emin misiniz?"))try{await E.deleteMessage(n),m(d=>d.filter(_=>_.id!==n)),f.success("Mesaj silindi")}catch(d){console.error("Failed to delete message:",d),f.error("Mesaj silinirken hata oluştu")}},D=n=>{v(n)},V=n=>{i(n),m([]),v(null),C(null)},ce=()=>{P(!0),i(null)},le=()=>N.filter(n=>!n.left_at).length,de=()=>r?r.conversation_type==="group"?r.name||"İsimsiz Grup":"Direkt Mesaj":"";return e.jsxs("div",{className:"h-[calc(100vh-8rem)] flex bg-background",children:[e.jsx("div",{className:`${y?"block":"hidden"} md:block`,children:e.jsx(Oe,{conversations:t,selectedConversationId:r==null?void 0:r.id,onSelectConversation:V,onCreateConversation:()=>{},loading:g,currentUserId:K})}),e.jsx("div",{className:`flex-1 flex flex-col ${y?"hidden":"flex"} md:flex`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b bg-card flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(z,{variant:"ghost",size:"sm",className:"md:hidden",onClick:ce,children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white",children:r.conversation_type==="group"?e.jsx(Z,{className:"h-5 w-5"}):"U"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:de()}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.conversation_type==="group"?`${le()} katılımcı`:"Aktif"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(z,{variant:"ghost",size:"sm",children:e.jsx(we,{className:"h-4 w-4"})}),e.jsx(z,{variant:"ghost",size:"sm",children:e.jsx(Se,{className:"h-4 w-4"})}),e.jsx(z,{variant:"ghost",size:"sm",children:e.jsx(_e,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:k?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Mesajlar yükleniyor..."})]}):u.length>0?e.jsxs(e.Fragment,{children:[u.map((n,d)=>{const _=n.sender_id===K,L=d===0||u[d-1].sender_id!==n.sender_id||new Date(n.created_at).getTime()-new Date(u[d-1].created_at).getTime()>5*60*1e3;return e.jsx(ze,{message:n,isCurrentUser:_,showSender:L&&r.conversation_type==="group",onReply:D,onEdit:Q,onDelete:O,onFileDownload:(I,$)=>{const H=document.createElement("a");H.href=I,H.download=$,H.click()},isEditing:R===n.id,onSaveEdit:a,onCancelEdit:c},n.id)}),e.jsx("div",{ref:w})]}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(oe,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Henüz mesaj yok"}),e.jsx("p",{className:"text-sm",children:"İlk mesajı göndererek konuşmayı başlatın"})]})}),e.jsx(Ie,{onSendMessage:Y,onFileUpload:G,replyingTo:h,onCancelReply:()=>v(null),placeholder:"Mesajınızı yazın..."})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center bg-muted/20",children:e.jsxs("div",{children:[e.jsx(Z,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground/50"}),e.jsx("h3",{className:"text-lg font-medium text-muted-foreground",children:"Konuşma Seçin"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Mesajlaşmaya başlamak için soldaki listeden bir konuşma seçin"})]})})})]})}export{Fe as default};
