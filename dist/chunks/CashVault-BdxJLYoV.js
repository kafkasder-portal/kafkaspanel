import{r as e,V as a,j as t,a9 as s,T as r,az as n,k as l,S as i,n as d,D as o,X as c}from"../assets/index-C7XW2vnU.js";import{e as m}from"./exportToCsv-DLkyd1nM.js";import{D as u}from"./DataTable-BR_3tqT5.js";import{M as x}from"./Modal-QxY_FyG0.js";import{S as h}from"./StatCard-BDZzrbVN.js";import{u as p,t as b,o as y,s as j,e as v}from"./types-Drtxg6gu.js";import{V as g}from"./index-DGkWrISs.js";import{E as f}from"./eye-Bpapn1fj.js";const N=y({payment_method:v(["cash","bank_transfer","check"],{message:"Ödeme yöntemi seçiniz"}),bank_account:j().optional(),transaction_ref:j().optional(),notes:j().optional()});function k(){var y,j,v;const[k,w]=e.useState([]),[_,D]=e.useState({totalApproved:0,totalDistributed:0,pendingDistribution:0,monthlyTotal:0}),[S,T]=e.useState(!0),[C,Y]=e.useState(""),[B,O]=e.useState("all"),[q,L]=e.useState("all"),[M,R]=e.useState(!1),[A,z]=e.useState(null),{register:E,handleSubmit:H,formState:{errors:I},reset:V,watch:$}=p({resolver:b(N)}),F=$("payment_method");e.useEffect(()=>{K(),G()},[]);const K=async()=>{try{const{data:e,error:t}=await a.from("aid_records").select("\n          *,\n          beneficiaries (\n            name,\n            surname,\n            phone,\n            category\n          ),\n          payments (\n            id,\n            payment_method,\n            amount,\n            status,\n            paid_at\n          )\n        ").eq("aid_type","cash").order("created_at",{ascending:!1});if(t)throw t;w(e||[])}catch(e){g.error("Nakdi yardım kayıtları yüklenirken hata oluştu")}finally{T(!1)}},G=async()=>{try{const{data:e}=await a.from("aid_records").select("amount").eq("aid_type","cash").eq("status","approved"),t=(null==e?void 0:e.reduce((e,a)=>e+(a.amount||0),0))||0,{data:s}=await a.from("aid_records").select("amount").eq("aid_type","cash").in("status",["distributed","completed"]),r=(null==s?void 0:s.reduce((e,a)=>e+(a.amount||0),0))||0,n=t-r,l=(new Date).toISOString().slice(0,7),{data:i}=await a.from("aid_records").select("amount").eq("aid_type","cash").gte("created_at",`${l}-01`),d=(null==i?void 0:i.reduce((e,a)=>e+(a.amount||0),0))||0;D({totalApproved:t,totalDistributed:r,pendingDistribution:n,monthlyTotal:d})}catch(e){}},J=e.useMemo(()=>k.filter(e=>{var a,t,s;const r=""===C||`${null==(a=e.beneficiaries)?void 0:a.name} ${null==(t=e.beneficiaries)?void 0:t.surname}`.toLowerCase().includes(C.toLowerCase())||(null==(s=e.notes)?void 0:s.toLowerCase().includes(C.toLowerCase())),n="all"===B||e.status===B;let l=!0;if("all"!==q){const a=new Date(e.created_at),t=new Date;switch(q){case"today":l=a.toDateString()===t.toDateString();break;case"week":l=a>=new Date(t.getTime()-6048e5);break;case"month":l=a.getMonth()===t.getMonth()&&a.getFullYear()===t.getFullYear()}}return r&&n&&l}),[k,C,B,q]),P=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(e),Q=e=>new Date(e).toLocaleDateString("tr-TR"),U=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(e,a)=>{var s,r,n;return t.jsxs("div",{children:[t.jsxs("div",{className:"font-medium",children:[null==(s=a.beneficiaries)?void 0:s.name," ",null==(r=a.beneficiaries)?void 0:r.surname]}),t.jsx("div",{className:"text-sm text-muted-foreground",children:null==(n=a.beneficiaries)?void 0:n.category})]})}},{key:"amount",header:"Tutar",render:(e,a)=>t.jsx("div",{className:"font-medium text-green-600",children:P(a.amount)})},{key:"status",header:"Durum",render:(e,a)=>(e=>{const a={approved:{label:"Onaylandı",class:"bg-green-100 text-green-800",icon:s},distributed:{label:"Dağıtıldı",class:"bg-blue-100 text-blue-800",icon:r},completed:{label:"Tamamlandı",class:"bg-purple-100 text-purple-800",icon:s},cancelled:{label:"İptal Edildi",class:"bg-red-100 text-red-800",icon:c}}[e]||{label:e,class:"bg-gray-100 text-gray-800",icon:s},n=a.icon;return t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${a.class}`,children:[t.jsx(n,{className:"h-3 w-3"}),a.label]})})(a.status)},{key:"approved_at",header:"Onay Tarihi",render:(e,a)=>Q(a.approved_at)},{key:"distributed_at",header:"Dağıtım Tarihi",render:(e,a)=>a.distributed_at?Q(a.distributed_at):"-"},{key:"payments",header:"Ödeme Yöntemi",render:(e,a)=>{var t;const s=null==(t=a.payments)?void 0:t[0];return s?{cash:"Nakit",bank_transfer:"Banka Havalesi",check:"Çek"}[r=s.payment_method]||r:"-";var r}},{key:"notes",header:"Notlar",render:(e,a)=>t.jsx("div",{className:"max-w-xs truncate",title:a.notes,children:a.notes||"-"})},{key:"actions",header:"İşlemler",render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:["approved"===a.status&&t.jsx("button",{onClick:()=>{z(a),R(!0)},className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Dağıt",children:t.jsx(o,{className:"h-4 w-4"})}),t.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:t.jsx(f,{className:"h-4 w-4"})})]})}];return S?t.jsx("div",{className:"flex h-64 items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),t.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Nakdi Yardım Veznesi"}),t.jsx("p",{className:"text-muted-foreground",children:"Nakdi yardımları yönetin ve dağıtın"})]})}),t.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[t.jsx(h,{title:"Toplam Onaylanan",value:P(_.totalApproved),icon:s,accentClass:"bg-green-100"}),t.jsx(h,{title:"Toplam Dağıtılan",value:P(_.totalDistributed),icon:r,accentClass:"bg-blue-100"}),t.jsx(h,{title:"Dağıtım Bekleyen",value:P(_.pendingDistribution),icon:n,accentClass:"bg-orange-100"}),t.jsx(h,{title:"Bu Ay Toplam",value:P(_.monthlyTotal),icon:l,accentClass:"bg-purple-100"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(i,{className:"h-4 w-4 text-muted-foreground"}),t.jsx("input",{type:"text",placeholder:"Kayıt ara...",value:C,onChange:e=>Y(e.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),t.jsxs("select",{value:B,onChange:e=>O(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"all",children:"Tüm Durumlar"}),t.jsx("option",{value:"approved",children:"Onaylanan"}),t.jsx("option",{value:"distributed",children:"Dağıtılan"}),t.jsx("option",{value:"completed",children:"Tamamlanan"}),t.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),t.jsxs("select",{value:q,onChange:e=>L(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"all",children:"Tüm Tarihler"}),t.jsx("option",{value:"today",children:"Bugün"}),t.jsx("option",{value:"week",children:"Bu Hafta"}),t.jsx("option",{value:"month",children:"Bu Ay"})]}),t.jsxs("button",{onClick:()=>m("nakdi-yardim-kayitlari.csv",J),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[t.jsx(d,{className:"h-4 w-4"}),"İndir"]}),t.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[J.length," kayıt"]})]}),t.jsx(u,{columns:U,data:J}),t.jsxs(x,{open:M,onClose:()=>R(!1),children:[t.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Nakdi Yardım Dağıtımı"}),t.jsx("button",{onClick:()=>R(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),A&&t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{className:"rounded border p-4 bg-gray-50",children:[t.jsx("h3",{className:"font-medium mb-2",children:"Yardım Detayları"}),t.jsxs("div",{className:"space-y-2 text-sm",children:[t.jsxs("div",{children:[t.jsx("strong",{children:"İhtiyaç Sahibi:"})," ",null==(y=A.beneficiaries)?void 0:y.name," ",null==(j=A.beneficiaries)?void 0:j.surname]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Kategori:"})," ",null==(v=A.beneficiaries)?void 0:v.category]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Tutar:"})," ",P(A.amount)]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Onay Tarihi:"})," ",(W=A.approved_at,new Date(W).toLocaleString("tr-TR"))]}),A.notes&&t.jsxs("div",{children:[t.jsx("strong",{children:"Notlar:"})," ",A.notes]})]})]}),t.jsxs("form",{onSubmit:H(async e=>{if(A)try{const{error:t}=await a.from("payments").insert({aid_record_id:A.id,payment_method:e.payment_method,amount:A.amount,bank_account:e.bank_account,transaction_ref:e.transaction_ref,status:"completed",paid_at:(new Date).toISOString(),notes:e.notes});if(t)throw t;const{error:s}=await a.from("aid_records").update({status:"distributed",distributed_at:(new Date).toISOString()}).eq("id",A.id);if(s)throw s;g.success("Nakdi yardım başarıyla dağıtıldı"),R(!1),z(null),V(),K(),G()}catch(t){g.error("Nakdi yardım dağıtılırken hata oluştu")}}),className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Ödeme Yöntemi *"}),t.jsxs("select",{...E("payment_method"),className:"w-full rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"Seçiniz..."}),t.jsx("option",{value:"cash",children:"Nakit"}),t.jsx("option",{value:"bank_transfer",children:"Banka Havalesi"}),t.jsx("option",{value:"check",children:"Çek"})]}),I.payment_method&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:I.payment_method.message})]}),"bank_transfer"===F&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Hesap No"}),t.jsx("input",{type:"text",...E("bank_account"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00"})]}),("bank_transfer"===F||"check"===F)&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"İşlem Referansı"}),t.jsx("input",{type:"text",...E("transaction_ref"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"İşlem numarası veya referans kodu"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),t.jsx("textarea",{...E("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Dağıtım ile ilgili notlar..."})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx("button",{type:"button",onClick:()=>R(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),t.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-green-600 px-4 py-2 text-sm text-white hover:bg-green-700",children:[t.jsx(o,{className:"h-4 w-4"}),"Dağıt"]})]})]})]})]})]});var W}export{k as default};
