import{t as e,ao as t,r as s,j as a,c as n,e as r,S as i,b6 as o,K as l,s as c,b7 as d,b8 as m,b4 as u,b5 as x,i as p,a9 as h,X as g,n as y,A as f,b9 as v,o as w,b as j,P as _,I as b,V as N}from"../assets/index-dW79Uy5k.js";import{A as k}from"./archive-Dtt2Bm8Q.js";import{P as S}from"./pen-BmZzhdTG.js";import{A as D}from"./arrow-left-ByNkIE2Q.js";import{V as C}from"./video-Det9spDy.js";const M=e("BellOff",[["path",{d:"M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5",key:"o7mx20"}],["path",{d:"M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7",key:"16f1lm"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),z=e("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]),I=e("Hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),O=e("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),E=e("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),K=(e,s)=>{const a=(null==e?void 0:e.message)||`Error in ${s}`;throw t.error(a),new Error(a)},R=()=>[{id:"conv_1",name:"Yönetim Kurulu",conversation_type:"group",created_by:"user1",description:"Yönetim kurulu iç iletişimi",is_archived:!1,last_message_at:new Date(Date.now()-18e5).toISOString(),created_at:new Date(Date.now()-2592e6).toISOString(),updated_at:(new Date).toISOString()},{id:"conv_2",name:"Proje Koordinasyonu",conversation_type:"group",created_by:"user2",description:"Aktif projeler için koordinasyon",is_archived:!1,last_message_at:new Date(Date.now()-72e5).toISOString(),created_at:new Date(Date.now()-1296e6).toISOString(),updated_at:(new Date).toISOString()},{id:"conv_3",conversation_type:"direct",created_by:"user1",is_archived:!1,last_message_at:new Date(Date.now()-3e5).toISOString(),created_at:new Date(Date.now()-6048e5).toISOString(),updated_at:(new Date).toISOString()}],A=e=>[{id:"msg_1",sender_id:"user1",conversation_id:e,content:"Merhaba, toplantı için gündem maddelerini gözden geçirelim.",message_type:"text",created_at:new Date(Date.now()-36e5).toISOString(),updated_at:new Date(Date.now()-36e5).toISOString()},{id:"msg_2",sender_id:"user2",conversation_id:e,content:"Evet, bütçe konularını da ekleyelim. Dosyayı paylaşıyorum.",message_type:"text",created_at:new Date(Date.now()-27e5).toISOString(),updated_at:new Date(Date.now()-27e5).toISOString()},{id:"msg_3",sender_id:"user2",conversation_id:e,content:"budget_2024.pdf",message_type:"file",file_url:"https://example.com/budget_2024.pdf",file_name:"budget_2024.pdf",file_size:245760,created_at:new Date(Date.now()-18e5).toISOString(),updated_at:new Date(Date.now()-18e5).toISOString()},{id:"msg_4",sender_id:"user3",conversation_id:e,content:"Harika! Ben de proje raporlarını hazırladım. Yarın sunabilirim.",message_type:"text",reply_to:"msg_2",created_at:new Date(Date.now()-9e5).toISOString(),updated_at:new Date(Date.now()-9e5).toISOString()},{id:"msg_5",sender_id:"user1",conversation_id:e,content:"Mükemmel! O zaman yarın saat 14:00'da başlayalım.",message_type:"text",created_at:new Date(Date.now()-3e5).toISOString(),updated_at:new Date(Date.now()-3e5).toISOString()}],P={async getConversations(){try{return R()}catch(e){return K(e,"getConversations"),[]}},async getConversation(e){try{return R().find(t=>t.id===e)||null}catch(t){return K(t,"getConversation"),null}},async createConversation(e){try{const s={id:`conv_${Date.now()}`,name:e.name,conversation_type:e.conversation_type,created_by:"current_user",description:e.description,is_archived:!1,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};return e.participants.length>0&&await this.addParticipants(s.id,e.participants),t.success("Konuşma oluşturuldu"),s}catch(s){throw K(s,"createConversation"),s}},async updateConversation(e,s){try{const a=R().find(t=>t.id===e);if(!a)throw new Error("Konuşma bulunamadı");const n={...a,...s,updated_at:(new Date).toISOString()};return t.success("Konuşma güncellendi"),n}catch(a){throw K(a,"updateConversation"),a}},async deleteConversation(e){try{t.success("Konuşma silindi")}catch(s){throw K(s,"deleteConversation"),s}},async archiveConversation(e){try{t.success("Konuşma arşivlendi")}catch(s){throw K(s,"archiveConversation"),s}},async getMessages(e){try{return A(e)}catch(t){return K(t,"getMessages"),[]}},async sendMessage(e){try{const t={id:`msg_${Date.now()}`,sender_id:"current_user",conversation_id:e.conversation_id,content:e.content,message_type:e.message_type||"text",file_url:e.file_url,file_name:e.file_name,file_size:e.file_size,reply_to:e.reply_to,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};return await this.updateConversationLastMessage(e.conversation_id),t}catch(t){throw K(t,"sendMessage"),t}},async editMessage(e,s){try{const a=A("conv_1").find(t=>t.id===e);if(!a)throw new Error("Mesaj bulunamadı");const n={...a,content:s,edited_at:(new Date).toISOString(),updated_at:(new Date).toISOString()};return t.success("Mesaj düzenlendi"),n}catch(a){throw K(a,"editMessage"),a}},async deleteMessage(e){try{t.success("Mesaj silindi")}catch(s){throw K(s,"deleteMessage"),s}},async markMessageAsRead(e){},async getConversationParticipants(e){try{return(e=>[{id:"part_1",conversation_id:e,user_id:"user1",role:"admin",joined_at:new Date(Date.now()-2592e6).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-6e5).toISOString()},{id:"part_2",conversation_id:e,user_id:"user2",role:"member",joined_at:new Date(Date.now()-216e7).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-12e5).toISOString()},{id:"part_3",conversation_id:e,user_id:"user3",role:"member",joined_at:new Date(Date.now()-1728e6).toISOString(),is_muted:!1,last_read_at:new Date(Date.now()-3e5).toISOString()}])(e)}catch(t){return K(t,"getConversationParticipants"),[]}},async addParticipants(e,s){try{const a=s.map(t=>({id:`part_${Date.now()}_${t}`,conversation_id:e,user_id:t,role:"member",joined_at:(new Date).toISOString(),is_muted:!1}));return t.success(`${s.length} katılımcı eklendi`),a}catch(a){throw K(a,"addParticipants"),a}},async removeParticipant(e,s){try{t.success("Katılımcı çıkarıldı")}catch(a){throw K(a,"removeParticipant"),a}},async updateParticipantRole(e,s,a){try{t.success("Katılımcı rolü güncellendi")}catch(n){throw K(n,"updateParticipantRole"),n}},async muteConversation(e,s,a){try{t.success(a?"Konuşma sessize alındı":"Konuşma sessize alma kaldırıldı")}catch(n){throw K(n,"muteConversation"),n}},async markConversationAsRead(e){},async addReaction(e,t){try{return{id:`reaction_${Date.now()}`,message_id:e,user_id:"current_user",emoji:t,created_at:(new Date).toISOString()}}catch(s){throw K(s,"addReaction"),s}},async removeReaction(e){},async getMessageReactions(e){try{return[{id:"reaction_1",message_id:e,user_id:"user1",emoji:"👍",created_at:(new Date).toISOString()},{id:"reaction_2",message_id:e,user_id:"user2",emoji:"❤️",created_at:(new Date).toISOString()}]}catch(t){return K(t,"getMessageReactions"),[]}},async searchMessages(e,t){try{return A(t||"conv_1").filter(t=>t.content.toLowerCase().includes(e.toLowerCase()))}catch(s){return K(s,"searchMessages"),[]}},async getNotifications(e){try{return[{id:"notif_1",user_id:e,conversation_id:"conv_1",message_id:"msg_1",type:"new_message",is_read:!1,created_at:new Date(Date.now()-18e5).toISOString()},{id:"notif_2",user_id:e,conversation_id:"conv_2",message_id:"msg_2",type:"mention",is_read:!1,created_at:new Date(Date.now()-36e5).toISOString()}]}catch(t){return K(t,"getNotifications"),[]}},async markNotificationAsRead(e){},subscribeToConversation:(e,t)=>({unsubscribe:()=>{}}),subscribeToNotifications:(e,t)=>({unsubscribe:()=>{}}),async updateConversationLastMessage(e){},async getUnreadCount(e,t){try{return Math.floor(5*Math.random())}catch(s){return 0}}};function H({conversations:e,selectedConversationId:t,onSelectConversation:h,onCreateConversation:g,onSearchConversations:y,onUpdateConversations:f,loading:v=!1,currentUserId:w}){const[j,_]=s.useState(""),[b,N]=s.useState(null),[S,D]=s.useState({}),[C,z]=s.useState(new Set),[O,E]=s.useState("all");s.useEffect(()=>{(async()=>{if(!w)return;const t={};for(const a of e)try{const e=await P.getUnreadCount(a.id,w);t[a.id]=e}catch(s){}D(t)})()},[e,w]),s.useEffect(()=>{z(new Set(["user1","user2","user3"]))},[]),s.useEffect(()=>{const e=()=>N(null);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[]);const K=e.filter(e=>{var t,s;const a=!j||(null==(t=e.name)?void 0:t.toLowerCase().includes(j.toLowerCase()))||(null==(s=e.description)?void 0:s.toLowerCase().includes(j.toLowerCase())),n="all"===O||"unread"===O&&(S[e.id]||0)>0||"groups"===O&&"group"===e.conversation_type||"direct"===O&&"direct"===e.conversation_type;return a&&n&&!e.is_archived}),R=e=>{if(!e)return"";const t=new Date(e),s=((new Date).getTime()-t.getTime())/36e5;return s<1?"şimdi":s<24?u(t,"HH:mm"):u(t,s<168?"EEE":"dd/MM",{locale:x})},A=e=>"group"===e.conversation_type?e.name||"İsimsiz Grup":"Direkt Mesaj",H=e=>e.avatar_url?a.jsx("img",{src:e.avatar_url,alt:A(e),className:"w-12 h-12 rounded-full object-cover"}):a.jsxs("div",{className:"w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white relative",children:["group"===e.conversation_type?a.jsx(p,{className:"h-6 w-6"}):a.jsx(m,{className:"h-6 w-6"}),"direct"===e.conversation_type&&C.has("user1")&&a.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 border-2 border-white rounded-full"})]});return a.jsxs("div",{className:"w-80 border-r bg-card flex flex-col h-full",children:[a.jsxs("div",{className:"p-4 border-b",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"font-semibold text-lg",children:"Mesajlar"}),g&&a.jsxs(n,{size:"sm",onClick:g,children:[a.jsx(r,{className:"h-4 w-4 mr-2"}),"Yeni"]})]}),a.jsxs("div",{className:"relative mb-3",children:[a.jsx(i,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),a.jsx("input",{type:"text",placeholder:"Konuşma ara...",value:j,onChange:e=>{return t=e.target.value,_(t),void(null==y||y(t));var t},className:"w-full pl-10 pr-3 py-2 border border-input rounded-md bg-background text-sm"})]}),a.jsx("div",{className:"flex space-x-1 p-1 bg-muted rounded-lg",children:[{id:"all",label:"Tümü",count:e.length},{id:"unread",label:"Okunmayan",count:Object.values(S).reduce((e,t)=>e+(t>0?1:0),0)},{id:"groups",label:"Gruplar",count:e.filter(e=>"group"===e.conversation_type).length},{id:"direct",label:"Direkt",count:e.filter(e=>"direct"===e.conversation_type).length}].map(e=>a.jsxs("button",{onClick:()=>E(e.id),className:"flex-1 text-xs py-1.5 px-2 rounded transition-colors "+(O===e.id?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:[e.label,e.count>0&&a.jsxs("span",{className:"ml-1 text-xs",children:["(",e.count,")"]})]},e.id))})]}),a.jsx("div",{className:"flex-1 overflow-y-auto",children:v?a.jsxs("div",{className:"p-4 text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Yükleniyor..."})]}):K.length>0?a.jsx("div",{className:"space-y-1 p-2",children:K.map(e=>{const s=(n=e.id,S[n]||0);var n;return a.jsxs("div",{className:"relative group cursor-pointer rounded-lg p-3 transition-colors "+(t===e.id?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"),onClick:()=>h(e),children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[H(e),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("h3",{className:"truncate "+(s>0?"font-semibold":"font-medium"),children:A(e)}),"group"===e.conversation_type&&a.jsx(I,{className:"h-3 w-3 text-muted-foreground"}),a.jsx(M,{className:"h-3 w-3 text-muted-foreground opacity-0"})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[s>0&&a.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full min-w-[18px] text-center font-medium",children:s>99?"99+":s}),e.last_message_at&&a.jsx("span",{className:"text-xs text-muted-foreground",children:R(e.last_message_at)}),a.jsx("button",{onClick:t=>((e,t)=>{e.stopPropagation(),N(b===t?null:t)})(t,e.id),className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-background/50 rounded transition-opacity",children:a.jsx(o,{className:"h-4 w-4"})})]})]}),a.jsx("div",{className:"flex items-center justify-between mt-1",children:a.jsx("p",{className:"text-sm truncate "+(s>0?"text-foreground":"text-muted-foreground"),children:e.description||"Henüz mesaj yok"})})]})]}),b===e.id&&a.jsxs("div",{className:"absolute top-12 right-3 bg-background border rounded-lg shadow-lg z-20 min-w-[160px]",children:[a.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",onClick:()=>(async e=>{if(w)try{await P.muteConversation(e,w,!0),N(null)}catch(t){}})(e.id),children:[a.jsx(M,{className:"h-4 w-4 mr-2"}),"Sessize Al"]}),"group"===e.conversation_type&&a.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[a.jsx(l,{className:"h-4 w-4 mr-2"}),"Grup Ayarları"]}),a.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",onClick:()=>(async e=>{try{await P.archiveConversation(e),null==f||f(),N(null)}catch(t){}})(e.id),children:[a.jsx(k,{className:"h-4 w-4 mr-2"}),"Arşivle"]}),a.jsx("div",{className:"border-t border-muted my-1"}),a.jsxs("button",{className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-destructive",onClick:()=>(async e=>{if(window.confirm("Bu konuşmayı silmek istediğinizden emin misiniz?"))try{await P.deleteConversation(e),null==f||f(),N(null)}catch(t){}})(e.id),children:[a.jsx(c,{className:"h-4 w-4 mr-2"}),"group"===e.conversation_type?"Gruptan Ayrıl":"Konuşmayı Sil"]})]})]},e.id)})}):a.jsx("div",{className:"p-8 text-center text-muted-foreground",children:j?a.jsxs("div",{children:[a.jsx(i,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{children:"Arama kriterlerine uygun konuşma bulunamadı"}),a.jsxs("p",{className:"text-xs mt-1",children:["'",j,"' için sonuç yok"]})]}):"unread"===O?a.jsxs("div",{children:[a.jsx(d,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{children:"Okunmamış mesaj yok"})]}):a.jsxs("div",{children:[a.jsx(m,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{children:"Henüz konuşma başlatılmamış"}),g&&a.jsx(n,{size:"sm",className:"mt-3",onClick:g,children:"İlk konuşmayı başlat"})]})})}),b&&a.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>{N(null)}})]})}function $({message:e,isCurrentUser:t,onReply:n,onEdit:r,onDelete:i,showSender:l=!0,onFileDownload:d,isEditing:m=!1,onSaveEdit:p,onCancelEdit:f}){const[v,w]=s.useState(!1),[j,_]=s.useState(e.content||""),b=()=>{j.trim()&&p&&p(e.id,j.trim())},N=()=>{_(e.content||""),null==f||f()};return a.jsxs("div",{className:"flex gap-3 group "+(t?"flex-row-reverse":""),children:[l&&!t&&a.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-sm flex-shrink-0",children:e.sender_id.charAt(0).toUpperCase()}),a.jsxs("div",{className:"flex-1 max-w-xs sm:max-w-md "+(t?"flex flex-col items-end":""),children:[l&&!t&&a.jsxs("div",{className:"text-sm text-muted-foreground mb-1",children:["Kullanıcı ",e.sender_id]}),e.reply_to&&a.jsxs("div",{className:"mb-2 p-2 bg-muted/50 border-l-2 border-primary rounded text-sm",children:[a.jsx("div",{className:"text-muted-foreground",children:"Yanıtlanan mesaj"}),a.jsx("div",{className:"truncate",children:"..."})]}),a.jsxs("div",{className:"relative rounded-lg p-3 "+("system"===e.message_type?"bg-muted/30 text-center":t?"bg-primary text-primary-foreground":"bg-card border"),children:[(()=>{if(m&&"text"===e.message_type)return a.jsxs("div",{className:"space-y-2",children:[a.jsx("textarea",{value:j,onChange:e=>_(e.target.value),className:"w-full p-2 border rounded resize-none focus:ring-2 focus:ring-primary focus:border-transparent",rows:3,autoFocus:!0,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey?"Escape"===e.key&&N():(e.preventDefault(),b())}}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("button",{onClick:b,disabled:!j.trim(),className:"flex items-center gap-1 px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed",children:[a.jsx(h,{className:"h-3 w-3"}),"Kaydet"]}),a.jsxs("button",{onClick:N,className:"flex items-center gap-1 px-2 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600",children:[a.jsx(g,{className:"h-3 w-3"}),"İptal"]})]})]});switch(e.message_type){case"file":return a.jsxs("div",{className:"flex items-center space-x-3 p-3 border rounded-lg bg-muted/50",children:[a.jsx(z,{className:"h-8 w-8 text-blue-500"}),a.jsxs("div",{className:"flex-1",children:[a.jsx("div",{className:"font-medium",children:e.file_name}),e.file_size&&a.jsxs("div",{className:"text-sm text-muted-foreground",children:[(e.file_size/1024/1024).toFixed(2)," MB"]})]}),e.file_url&&a.jsx("button",{onClick:()=>null==d?void 0:d(e.file_url,e.file_name),className:"p-2 hover:bg-muted rounded-md",children:a.jsx(y,{className:"h-4 w-4"})})]});case"image":return a.jsxs("div",{className:"space-y-2",children:[e.file_url&&a.jsx("img",{src:e.file_url,alt:e.file_name||"Resim",className:"max-w-xs rounded-lg cursor-pointer hover:opacity-90",onClick:()=>window.open(e.file_url,"_blank")}),e.content&&a.jsx("div",{className:"text-sm",children:e.content})]});case"system":return a.jsx("div",{className:"text-sm text-muted-foreground italic",children:e.content});default:return a.jsx("div",{className:"whitespace-pre-wrap break-words",children:e.content})}})(),a.jsxs("div",{className:"text-xs mt-2 "+("system"===e.message_type?"text-muted-foreground":t?"text-primary-foreground/70":"text-muted-foreground"),children:[(e=>{const t=new Date(e),s=new Date;return t.toDateString()===s.toDateString()?u(t,"HH:mm"):u(t,"dd MMM HH:mm",{locale:x})})(e.created_at),e.edited_at&&a.jsx("span",{className:"ml-1",children:"(düzenlendi)"})]}),"system"!==e.message_type&&!m&&a.jsx("div",{className:"absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsxs("div",{className:"relative",children:[a.jsx("button",{onClick:()=>w(!v),className:"p-1 hover:bg-background/20 rounded",children:a.jsx(o,{className:"h-3 w-3"})}),v&&a.jsxs("div",{className:"absolute top-full right-0 mt-1 bg-background border rounded-lg shadow-lg z-10 min-w-[120px]",children:[n&&a.jsxs("button",{onClick:()=>{n(e),w(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-t-lg flex items-center",children:[a.jsx(E,{className:"h-3 w-3 mr-2"}),"Yanıtla"]}),t&&r&&"text"===e.message_type&&a.jsxs("button",{onClick:()=>{r(e),w(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted flex items-center",children:[a.jsx(S,{className:"h-3 w-3 mr-2"}),"Düzenle"]}),t&&i&&a.jsxs("button",{onClick:()=>{i(e.id),w(!1)},className:"w-full text-left px-3 py-2 text-sm hover:bg-muted rounded-b-lg flex items-center text-red-600",children:[a.jsx(c,{className:"h-3 w-3 mr-2"}),"Sil"]})]})]})})]})]}),v&&a.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>w(!1)})]})}function L({onSendMessage:e,onFileUpload:t,replyingTo:r,onCancelReply:i,disabled:o=!1,placeholder:l="Mesajınızı yazın..."}){const[c,d]=s.useState(""),[m,u]=s.useState(!1),[x,p]=s.useState(!1),h=s.useRef(null),y=s.useRef(null),j=async()=>{c.trim()&&!o&&(e(c.trim()),d(""),y.current&&(y.current.style.height="auto"))},_=async s=>{if(t){u(!0);try{const a=await t(s),n=s.type.startsWith("image/")?"image":"file";e(s.type.startsWith("image/")?"":`📎 ${a.name}`,n)}catch(a){}finally{u(!1)}}};return a.jsxs("div",{className:"border-t bg-background p-4",children:[r&&a.jsxs("div",{className:"mb-3 p-3 bg-muted/50 border-l-2 border-primary rounded flex items-center justify-between",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"text-sm text-muted-foreground",children:["Kullanıcı ",r.sender_id," kullanıcısına yanıt veriyor"]}),a.jsx("div",{className:"text-sm truncate mt-1",children:r.content||("file"===r.message_type?`📎 ${r.file_name}`:"Dosya")})]}),i&&a.jsx(n,{size:"sm",variant:"ghost",onClick:i,children:a.jsx(g,{className:"h-4 w-4"})})]}),a.jsxs("div",{className:"relative "+(x?"bg-primary/10 border-primary":""),onDrop:e=>{e.preventDefault(),p(!1);const t=e.dataTransfer.files[0];t&&_(t)},onDragOver:e=>{e.preventDefault(),p(!0)},onDragLeave:e=>{e.preventDefault(),p(!1)},children:[x&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-primary/5 border-2 border-dashed border-primary rounded-lg z-10",children:a.jsxs("div",{className:"text-center",children:[a.jsx(f,{className:"h-8 w-8 mx-auto text-primary mb-2"}),a.jsx("p",{className:"text-primary font-medium",children:"Dosyayı buraya bırakın"})]})}),a.jsxs("div",{className:"flex items-end space-x-2",children:[t&&a.jsxs("div",{className:"flex space-x-1",children:[a.jsx("input",{ref:h,type:"file",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];s&&_(s)},className:"hidden",accept:"*/*"}),a.jsx(n,{type:"button",size:"sm",variant:"ghost",onClick:()=>{var e;return null==(e=h.current)?void 0:e.click()},disabled:o||m,className:"p-2",children:a.jsx(f,{className:"h-4 w-4"})}),a.jsx(n,{type:"button",size:"sm",variant:"ghost",onClick:()=>{h.current&&(h.current.accept="image/*",h.current.click())},disabled:o||m,className:"p-2",children:a.jsx(O,{className:"h-4 w-4"})})]}),a.jsxs("div",{className:"flex-1 relative",children:[a.jsx("textarea",{ref:y,value:c,onChange:e=>{var t;d(e.target.value),(t=e.target).style.height="auto",t.style.height=Math.min(t.scrollHeight,120)+"px"},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),j())},placeholder:m?"Dosya yükleniyor...":l,disabled:o||m,className:"w-full min-h-[40px] max-h-[120px] px-3 py-2 border border-input rounded-md bg-background resize-none focus:ring-2 focus:ring-ring focus:border-transparent",rows:1}),a.jsx(n,{type:"button",size:"sm",variant:"ghost",className:"absolute right-2 top-1/2 transform -translate-y-1/2 p-1",disabled:o,children:a.jsx(v,{className:"h-4 w-4"})})]}),a.jsx(n,{onClick:j,disabled:!c.trim()||o||m,size:"sm",className:"p-2",children:a.jsx(w,{className:"h-4 w-4"})})]}),m&&a.jsxs("div",{className:"mt-2 text-sm text-muted-foreground flex items-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"}),"Dosya yükleniyor..."]})]}),a.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[a.jsx("span",{children:"Enter ile gönder, Shift+Enter ile yeni satır"}),t&&a.jsx("span",{className:"ml-2",children:"• Dosya yüklemek için sürükleyip bırakabilirsiniz"})]})]})}function U(){const[e,r]=s.useState([]),[i,o]=s.useState(null),[l,c]=s.useState([]),[d,m]=s.useState([]),[u,x]=s.useState(!0),[h,g]=s.useState(!1),[y,f]=s.useState(null),[v,k]=s.useState(null),[S,M]=s.useState(!0),z=s.useRef(null),{user:I}=j(),O=null==I?void 0:I.id;s.useEffect(()=>{E()},[!0]),s.useEffect(()=>{i&&(K(i.id),R(i.id),M(!1))},[i]),s.useEffect(()=>{A()},[l]);const E=async()=>{x(!0);try{const e=await P.getConversations();r(e)}catch(e){t.error("Konuşmalar yüklenirken hata oluştu")}finally{x(!1)}},K=async e=>{g(!0);try{const t=await P.getMessages(e);c(t),await P.markConversationAsRead(e)}catch(s){t.error("Mesajlar yüklenirken hata oluştu")}finally{g(!1)}},R=async e=>{try{const t=await P.getConversationParticipants(e);m(t)}catch(t){}},A=()=>{var e;null==(e=z.current)||e.scrollIntoView({behavior:"smooth"})},U=async e=>{k(e.id)},T=async(e,s)=>{try{const{error:t}=await N.from("internal_messages").update({content:s,updated_at:(new Date).toISOString()}).eq("id",e);if(t)throw t;c(t=>t.map(t=>t.id===e?{...t,content:s,updated_at:(new Date).toISOString()}:t)),k(null)}catch(a){t.error("Mesaj güncellenirken bir hata oluştu")}},F=()=>{k(null)},Y=async e=>{if(window.confirm("Bu mesajı silmek istediğinizden emin misiniz?"))try{await P.deleteMessage(e),c(t=>t.filter(t=>t.id!==e)),t.success("Mesaj silindi")}catch(s){t.error("Mesaj silinirken hata oluştu")}},B=e=>{f(e)};return a.jsxs("div",{className:"h-[calc(100vh-8rem)] flex bg-background",children:[a.jsx("div",{className:(S?"block":"hidden")+" md:block",children:a.jsx(H,{conversations:e,selectedConversationId:null==i?void 0:i.id,onSelectConversation:e=>{o(e),c([]),f(null),k(null)},onCreateConversation:()=>{},loading:u,currentUserId:O})}),a.jsx("div",{className:`flex-1 flex flex-col ${S?"hidden":"flex"} md:flex`,children:i?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"p-4 border-b bg-card flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx(n,{variant:"ghost",size:"sm",className:"md:hidden",onClick:()=>{M(!0),o(null)},children:a.jsx(D,{className:"h-4 w-4"})}),a.jsx("div",{className:"w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white",children:"group"===i.conversation_type?a.jsx(p,{className:"h-5 w-5"}):"U"}),a.jsxs("div",{children:[a.jsx("h3",{className:"font-semibold",children:i?"group"===i.conversation_type?i.name||"İsimsiz Grup":"Direkt Mesaj":""}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"group"===i.conversation_type?`${d.filter(e=>!e.left_at).length} katılımcı`:"Aktif"})]})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(n,{variant:"ghost",size:"sm",children:a.jsx(_,{className:"h-4 w-4"})}),a.jsx(n,{variant:"ghost",size:"sm",children:a.jsx(C,{className:"h-4 w-4"})}),a.jsx(n,{variant:"ghost",size:"sm",children:a.jsx(b,{className:"h-4 w-4"})})]})]}),a.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:h?a.jsxs("div",{className:"text-center py-8",children:[a.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto"}),a.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Mesajlar yükleniyor..."})]}):l.length>0?a.jsxs(a.Fragment,{children:[l.map((e,t)=>{const s=e.sender_id===O,n=0===t||l[t-1].sender_id!==e.sender_id||new Date(e.created_at).getTime()-new Date(l[t-1].created_at).getTime()>3e5;return a.jsx($,{message:e,isCurrentUser:s,showSender:n&&"group"===i.conversation_type,onReply:B,onEdit:U,onDelete:Y,onFileDownload:(e,t)=>{const s=document.createElement("a");s.href=e,s.download=t,s.click()},isEditing:v===e.id,onSaveEdit:T,onCancelEdit:F},e.id)}),a.jsx("div",{ref:z})]}):a.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[a.jsx(w,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{children:"Henüz mesaj yok"}),a.jsx("p",{className:"text-sm",children:"İlk mesajı göndererek konuşmayı başlatın"})]})}),a.jsx(L,{onSendMessage:async(e,s="text")=>{if(i)try{const t={conversation_id:i.id,content:e,message_type:s,reply_to:null==y?void 0:y.id},a=await P.sendMessage(t);c(e=>[...e,a]),f(null),r(e=>e.map(e=>e.id===i.id?{...e,last_message_at:a.created_at}:e))}catch(a){t.error("Mesaj gönderilirken hata oluştu")}},onFileUpload:async e=>{try{const t=10485760,s=["image/jpeg","image/png","image/gif","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"];if(e.size>t)throw new Error("Dosya boyutu 10MB'den küçük olmalıdır");if(!s.includes(e.type))throw new Error("Desteklenmeyen dosya türü");const a=e.name.split(".").pop(),n=`internal-messages/${Date.now()}_${Math.random().toString(36).substring(2)}.${a}`,{error:r}=await N.storage.from("uploads").upload(n,e);if(r)throw r;const{data:i}=N.storage.from("uploads").getPublicUrl(n);return{url:i.publicUrl,name:e.name,size:e.size,path:n}}catch(t){throw t}},replyingTo:y,onCancelReply:()=>f(null),placeholder:"Mesajınızı yazın..."})]}):a.jsx("div",{className:"flex-1 flex items-center justify-center text-center bg-muted/20",children:a.jsxs("div",{children:[a.jsx(p,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground/50"}),a.jsx("h3",{className:"text-lg font-medium text-muted-foreground",children:"Konuşma Seçin"}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Mesajlaşmaya başlamak için soldaki listeden bir konuşma seçin"})]})})})]})}export{U as default};
