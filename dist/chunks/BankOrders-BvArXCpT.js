import{r as e,V as a,j as t,o as s,e as r,q as n,a9 as l,D as i,S as d,n as c,X as o}from"../assets/index-C7XW2vnU.js";import{e as m}from"./exportToCsv-DLkyd1nM.js";import{D as u}from"./DataTable-BR_3tqT5.js";import{M as x}from"./Modal-QxY_FyG0.js";import{S as h}from"./StatCard-BDZzrbVN.js";import{u as p,t as b,o as g,s as j,n as f}from"./types-Drtxg6gu.js";import{V as y}from"./index-DGkWrISs.js";import{A as N}from"./alert-circle-W3dFygZp.js";import{E as v}from"./eye-Bpapn1fj.js";import{P as w}from"./pen-square-C-SOcf8u.js";const k=g({beneficiary_id:j().min(1,"İhtiyaç sahibi seçiniz"),aid_record_id:j().min(1,"Yardım kaydı seçiniz"),amount:f().min(1,"Tutar giriniz"),bank_name:j().min(1,"Banka adı giriniz"),account_number:j().min(1,"Hesap numarası giriniz"),account_holder:j().min(1,"Hesap sahibi giriniz"),iban:j().min(26,"Geçerli IBAN giriniz").max(34),notes:j().optional()});function _(){const[g,j]=e.useState([]),[f,_]=e.useState({totalPending:0,totalSent:0,totalCompleted:0,totalAmount:0}),[S,C]=e.useState(!0),[B,T]=e.useState(""),[D,E]=e.useState("all"),[z,L]=e.useState("all"),[A,q]=e.useState(!1),[G,Y]=e.useState(!1),[H,M]=e.useState([]),[I,R]=e.useState([]),[$,F]=e.useState([]),{register:P,handleSubmit:V,formState:{errors:O},reset:K,watch:J}=p({resolver:b(k)}),Q=J("beneficiary_id");e.useEffect(()=>{U(),W(),X()},[]),e.useEffect(()=>{Q&&Z(Q)},[Q]);const U=async()=>{try{const{data:e,error:t}=await a.from("payments").select("\n          *,\n          beneficiaries (\n            name,\n            surname,\n            phone,\n            category\n          ),\n          aid_records (\n            aid_type,\n            amount,\n            notes\n          )\n        ").eq("payment_method","bank_transfer").order("created_at",{ascending:!1});if(t)throw t;j(e||[])}catch(e){y.error("Banka emirleri yüklenirken hata oluştu")}finally{C(!1)}},W=async()=>{try{const{data:e}=await a.from("payments").select("status, amount").eq("payment_method","bank_transfer");if(e){const a=e.filter(e=>"pending"===e.status).length,t=e.filter(e=>"sent"===e.status).length,s=e.filter(e=>"completed"===e.status).length,r=e.reduce((e,a)=>e+(a.amount||0),0);_({totalPending:a,totalSent:t,totalCompleted:s,totalAmount:r})}}catch(e){}},X=async()=>{try{const{data:e,error:t}=await a.from("beneficiaries").select("id, name, surname, category").eq("status","active").order("name");if(t)throw t;R(e||[])}catch(e){}},Z=async e=>{try{const{data:t,error:s}=await a.from("aid_records").select("id, aid_type, amount, notes").eq("beneficiary_id",e).eq("status","approved").order("created_at",{ascending:!1});if(s)throw s;F(t||[])}catch(t){}},ee=e.useMemo(()=>g.filter(e=>{var a,t,s;const r=""===B||`${null==(a=e.beneficiaries)?void 0:a.name} ${null==(t=e.beneficiaries)?void 0:t.surname}`.toLowerCase().includes(B.toLowerCase())||e.account_holder.toLowerCase().includes(B.toLowerCase())||e.bank_name.toLowerCase().includes(B.toLowerCase())||(null==(s=e.transaction_ref)?void 0:s.toLowerCase().includes(B.toLowerCase())),n="all"===D||e.status===D;let l=!0;if("all"!==z){const a=new Date(e.order_date),t=new Date;switch(z){case"today":l=a.toDateString()===t.toDateString();break;case"week":l=a>=new Date(t.getTime()-6048e5);break;case"month":l=a.getMonth()===t.getMonth()&&a.getFullYear()===t.getFullYear()}}return r&&n&&l}),[g,B,D,z]),ae=e=>new Intl.NumberFormat("tr-TR",{style:"currency",currency:"TRY"}).format(e),te=e=>new Date(e).toLocaleDateString("tr-TR"),se=g.filter(e=>"pending"===e.status),re=[{key:"beneficiaries",header:"İhtiyaç Sahibi",render:(e,a)=>{var s,r,n;return t.jsxs("div",{children:[t.jsxs("div",{className:"font-medium",children:[null==(s=a.beneficiaries)?void 0:s.name," ",null==(r=a.beneficiaries)?void 0:r.surname]}),t.jsx("div",{className:"text-sm text-muted-foreground",children:null==(n=a.beneficiaries)?void 0:n.category})]})}},{key:"amount",header:"Tutar",render:(e,a)=>t.jsx("div",{className:"font-medium text-green-600",children:ae(a.amount)})},{key:"bank_info",header:"Banka Bilgileri",render:(e,a)=>{return t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:a.bank_name}),t.jsx("div",{className:"text-sm text-muted-foreground",children:a.account_holder}),t.jsx("div",{className:"text-xs text-muted-foreground",children:(s=a.iban,s.replace(/(.{4})/g,"$1 ").trim())})]});var s}},{key:"status",header:"Durum",render:(e,a)=>(e=>{const a={pending:{label:"Beklemede",class:"bg-yellow-100 text-yellow-800",icon:n},sent:{label:"Gönderildi",class:"bg-blue-100 text-blue-800",icon:s},completed:{label:"Tamamlandı",class:"bg-green-100 text-green-800",icon:l},failed:{label:"Başarısız",class:"bg-red-100 text-red-800",icon:o},cancelled:{label:"İptal Edildi",class:"bg-gray-100 text-gray-800",icon:o}}[e]||{label:e,class:"bg-gray-100 text-gray-800",icon:N},r=a.icon;return t.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${a.class}`,children:[t.jsx(r,{className:"h-3 w-3"}),a.label]})})(a.status)},{key:"order_date",header:"Emir Tarihi",render:(e,a)=>te(a.order_date)},{key:"sent_date",header:"Gönderim Tarihi",render:(e,a)=>a.sent_date?te(a.sent_date):"-"},{key:"transaction_ref",header:"İşlem Ref.",render:(e,a)=>t.jsx("div",{className:"max-w-xs truncate",title:a.transaction_ref,children:a.transaction_ref||"-"})},{key:"actions",header:"İşlemler",render:(e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{className:"rounded p-1 text-gray-600 hover:bg-gray-50",title:"Detay",children:t.jsx(v,{className:"h-4 w-4"})}),"pending"===a.status&&t.jsx("button",{className:"rounded p-1 text-blue-600 hover:bg-blue-50",title:"Düzenle",children:t.jsx(w,{className:"h-4 w-4"})})]})}];return S?t.jsx("div",{className:"flex h-64 items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-2"}),t.jsx("p",{className:"text-muted-foreground",children:"Yükleniyor..."})]})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold",children:"Banka Ödeme Emirleri"}),t.jsx("p",{className:"text-muted-foreground",children:"Banka havalesi ile yapılacak ödemeleri yönetin"})]}),t.jsxs("div",{className:"flex gap-2",children:[se.length>0&&t.jsxs("button",{onClick:()=>{M(se),Y(!0)},className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[t.jsx(s,{className:"h-4 w-4"}),"Toplu Gönder (",se.length,")"]}),t.jsxs("button",{onClick:()=>q(!0),className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[t.jsx(r,{className:"h-4 w-4"}),"Yeni Emir"]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4",children:[t.jsx(h,{title:"Bekleyen Emirler",value:f.totalPending.toString(),icon:n,accentClass:"bg-yellow-100"}),t.jsx(h,{title:"Gönderilen Emirler",value:f.totalSent.toString(),icon:s,accentClass:"bg-blue-100"}),t.jsx(h,{title:"Tamamlanan Emirler",value:f.totalCompleted.toString(),icon:l,accentClass:"bg-green-100"}),t.jsx(h,{title:"Toplam Tutar",value:ae(f.totalAmount),icon:i,accentClass:"bg-purple-100"})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-4 rounded-lg border p-4",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(d,{className:"h-4 w-4 text-muted-foreground"}),t.jsx("input",{type:"text",placeholder:"Emir ara...",value:B,onChange:e=>T(e.target.value),className:"min-w-64 rounded border px-3 py-2 text-sm"})]}),t.jsxs("select",{value:D,onChange:e=>E(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"all",children:"Tüm Durumlar"}),t.jsx("option",{value:"pending",children:"Bekleyen"}),t.jsx("option",{value:"sent",children:"Gönderilen"}),t.jsx("option",{value:"completed",children:"Tamamlanan"}),t.jsx("option",{value:"failed",children:"Başarısız"}),t.jsx("option",{value:"cancelled",children:"İptal Edilen"})]}),t.jsxs("select",{value:z,onChange:e=>L(e.target.value),className:"rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"all",children:"Tüm Tarihler"}),t.jsx("option",{value:"today",children:"Bugün"}),t.jsx("option",{value:"week",children:"Bu Hafta"}),t.jsx("option",{value:"month",children:"Bu Ay"})]}),t.jsxs("button",{onClick:()=>m("banka-odeme-emirleri.csv",ee),className:"flex items-center gap-2 rounded bg-green-600 px-3 py-2 text-sm text-white hover:bg-green-700",children:[t.jsx(c,{className:"h-4 w-4"}),"İndir"]}),t.jsxs("div",{className:"ml-auto text-sm text-muted-foreground",children:[ee.length," emir"]})]}),t.jsx(u,{columns:re,data:ee}),t.jsxs(x,{open:A,onClose:()=>q(!1),children:[t.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Yeni Banka Ödeme Emri"}),t.jsx("button",{onClick:()=>q(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),t.jsxs("form",{onSubmit:V(async e=>{try{const{error:t}=await a.from("payments").insert({aid_record_id:e.aid_record_id,beneficiary_id:e.beneficiary_id,payment_method:"bank_transfer",amount:e.amount,bank_account:e.iban,bank_name:e.bank_name,account_number:e.account_number,account_holder:e.account_holder,status:"pending",notes:e.notes});if(t)throw t;y.success("Banka ödeme emri başarıyla oluşturuldu"),q(!1),K(),U(),W()}catch(t){y.error("Banka ödeme emri oluşturulurken hata oluştu")}}),className:"p-4 space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"İhtiyaç Sahibi *"}),t.jsxs("select",{...P("beneficiary_id"),className:"w-full rounded border px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"Seçiniz..."}),I.map(e=>t.jsxs("option",{value:e.id,children:[e.name," ",e.surname," - ",e.category]},e.id))]}),O.beneficiary_id&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.beneficiary_id.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Yardım Kaydı *"}),t.jsxs("select",{...P("aid_record_id"),className:"w-full rounded border px-3 py-2 text-sm",disabled:!Q,children:[t.jsx("option",{value:"",children:"Seçiniz..."}),$.map(e=>t.jsxs("option",{value:e.id,children:[e.aid_type," - ",ae(e.amount)]},e.id))]}),O.aid_record_id&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.aid_record_id.message})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Tutar *"}),t.jsx("input",{type:"number",step:"0.01",...P("amount",{valueAsNumber:!0}),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"0.00"}),O.amount&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.amount.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Banka Adı *"}),t.jsx("input",{type:"text",...P("bank_name"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Banka adı"}),O.bank_name&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.bank_name.message})]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Sahibi *"}),t.jsx("input",{type:"text",...P("account_holder"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap sahibinin adı"}),O.account_holder&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.account_holder.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Hesap Numarası *"}),t.jsx("input",{type:"text",...P("account_number"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Hesap numarası"}),O.account_number&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.account_number.message})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"IBAN *"}),t.jsx("input",{type:"text",...P("iban"),className:"w-full rounded border px-3 py-2 text-sm",placeholder:"TR00 0000 0000 0000 0000 0000 00",maxLength:34}),O.iban&&t.jsx("p",{className:"text-sm text-red-600 mt-1",children:O.iban.message})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-1",children:"Notlar"}),t.jsx("textarea",{...P("notes"),rows:3,className:"w-full rounded border px-3 py-2 text-sm",placeholder:"Ödeme emri ile ilgili notlar..."})]}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx("button",{type:"button",onClick:()=>q(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),t.jsxs("button",{type:"submit",className:"flex items-center gap-2 rounded bg-primary px-4 py-2 text-sm text-white hover:bg-primary/90",children:[t.jsx(r,{className:"h-4 w-4"}),"Oluştur"]})]})]})]}),t.jsxs(x,{open:G,onClose:()=>Y(!1),children:[t.jsxs("div",{className:"flex items-center justify-between border-b p-4",children:[t.jsx("h2",{className:"text-lg font-semibold",children:"Toplu Banka Ödeme Emri Gönderimi"}),t.jsx("button",{onClick:()=>Y(!1),className:"h-8 w-8 rounded-full bg-red-600 text-white hover:bg-red-700",children:"×"})]}),t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{className:"rounded border p-4 bg-yellow-50",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(N,{className:"h-5 w-5 text-yellow-600"}),t.jsx("h3",{className:"font-medium text-yellow-800",children:"Dikkat"})]}),t.jsxs("p",{className:"text-sm text-yellow-700",children:[H.length," adet banka ödeme emri gönderilecek. Bu işlem geri alınamaz."]})]}),t.jsx("div",{className:"max-h-64 overflow-y-auto",children:t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b",children:[t.jsx("th",{className:"text-left p-2",children:"İhtiyaç Sahibi"}),t.jsx("th",{className:"text-left p-2",children:"Tutar"}),t.jsx("th",{className:"text-left p-2",children:"Banka"})]})}),t.jsx("tbody",{children:H.map(e=>{var a,s;return t.jsxs("tr",{className:"border-b",children:[t.jsxs("td",{className:"p-2",children:[null==(a=e.beneficiaries)?void 0:a.name," ",null==(s=e.beneficiaries)?void 0:s.surname]}),t.jsx("td",{className:"p-2",children:ae(e.amount)}),t.jsx("td",{className:"p-2",children:e.bank_name})]},e.id)})})]})}),t.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[t.jsx("button",{onClick:()=>Y(!1),className:"rounded border px-4 py-2 text-sm hover:bg-gray-50",children:"İptal"}),t.jsxs("button",{onClick:async()=>{try{const e=H.map(e=>e.id),{error:t}=await a.from("payments").update({status:"sent",sent_date:(new Date).toISOString()}).in("id",e);if(t)throw t;y.success(`${H.length} adet banka ödeme emri gönderildi`),Y(!1),M([]),U(),W()}catch(e){y.error("Banka emirleri gönderilirken hata oluştu")}},className:"flex items-center gap-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:[t.jsx(s,{className:"h-4 w-4"}),"Gönder"]})]})]})]})]})}export{_ as default};
